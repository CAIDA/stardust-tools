**ftconvert**: converts flowtuple files made using a previous version of
corsaro into an avro file that conforms to the latest flowtuple data
format (currently flowtuple4).

## Dependencies

 - libcorsaro3 (version 3.3.0 or later)
 - libflowtuple


## Compilation:

Simply run `make` from within the same directory as the ftconvert source code.


## Usage

```
  ftconvert -o <output filename template> -V <previous version>
      -n <dest network aggregation> -I <interval length>
      <input file 1> [ <input file 2> ... ]
```

Input files must be flowtuple files created by either corsaro2 (typically these
will have a suffix of `.cors.gz`) or corsaro3 (which will have a suffix of
`.flowtuple.avro`). The -V flag must be set to 2 if converting corsaro2
files, or set to 3 if converting corsaro3 files.

`<output filename template>` will be used to name the avro file generated by
this program. Formatting tokens that are supported by `strftime()` may be
included in the template and will be substituted with time values based on
the interval timestamp. In addition, `%s` may be used and will be replaced
with the unix timestamp of the interval.

Interval length is specified in minutes. Flows with the same key that fall
in the same interval will be merged together. At the end of each interval,
the flows are written to an avro file using the flowtuple4 format and the
interval flow map is cleared. There will be one file for each interval.

The -n option must be set to either 16 (to aggregate destination addresses
based on their parent /16) or 24.

## Examples

Convert flowtuple2 files into 3 minutely flowtuple4 files, aggregating
destination IPs into /24s:

```
  ftconvert -o "example/avro/v2_3min_example_%s.ft.avro" -V 2 -n 24 -I 3 \
      swift://data-telescope-meta-flowtuple/datasource=ucsd-nt/year=2021/month=3/day=9/ucsd-nt.1615320000.flowtuple.cors.gz
```

Notes:
 * flowtuple2 files are 1 hour long, so this will create 20 flowtuple4 files.
 * each file will be named with the '%s' being replaced with the timestamp at
   the start of the corresponding 3 minute interval
 * flowtuple2 files can be read directly from swift using a wandio `swift://`
   URI.


----

Convert flowtuple3 files into 5 minutely flowtuple4 files, aggregating
destination IPs into /16s:

```
  ftconvert -o "example/avro/v3_5min_example_%s.ft.avro" -V 2 -n 16 -I 5 \
     ~/avrodownloads/ucsd-nt.161532*.avro
```

Notes:
 * flowtuple3 files are 1 minute long, so we need to specify multiple input
   files to cover an entire 5 minute interval.
 * flowtuple3 files CANNOT be read directly from swift unfortunately, so you
   must use `swift download` to copy them to a local disk and then provide
   the path to the downloaded files as your input list. On the plus side, you
   can then use bash glob wildcards to easily specify the set of input files.


## Flowtuple Formats

More information on the specific meanings of fields in the various flowtuple
formats can be found at
https://github.com/CAIDA/corsaro3/wiki/Flowtuple-Formats.

## Reading flowtuple4 avro files

To dump avro on the command-line, use the avro-tools jar file which you can
download from https://www.apache.org/dyn/closer.cgi/avro/ -- note that
you will require java to use this jar file.

To dump the avro file to stdout as a series of JSON objects, you can do
something like:

  java -jar avro-tools-<version>.jar tojson <input file>

There are also libraries available for most programming languages to read avro
files.


## Conversion Details

Some field in the flowtuple4 record are not present in the corsaro2
flowtuple format. The table below lists these fields, as well as the value
that will be assigned to them when converting a corsaro2 flowtuple to
flowtuple4.

Field             |  Default Value
------------------|----------------
first_syn_length  |  0
first_tcp_rwin    |  0
maxmind_continent  | ??
maxmind_country    | ??
netacq_continent  | ??
netacq_country    | ??
prefix2asn        |  0




